$def with (sscoll, ud, info)

$# set all statically loaded files for this template
$var cssfiles: //ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/themes/smoothness/jquery-ui.min.css /static/css/footable.core.min.css /static/css/footable.wff.min.css /static/css/wff.min.css
$var jsfiles: //ajax.googleapis.com/ajax/libs/jqueryui/1.10.3/jquery-ui.min.js //ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js /static/js/footable.min.js /static/js/footable.filter.js
$var title: webFlipFlapp
$var login_link: $info['login_url']
$var auth_link: $info['auth_url']
$var logout_link: $info['logout_url']
$var user_email: $info['email']
$var nickname: $info['nickname']
$var has_cred: $info['has_cred']

$ SPREADSHEETS = ud.spreadsheet_name.split(',')
$ CALENDARS = ud.calendar_name.split(',')
$ SSID = ud.spreadsheet_id.split(',')
$ CLID = ud.calendar_id.split(',')

<script>
    $$(function() {
        $$(".footable").footable();
        $$(".datepicker").datepicker({ dateFormat: "yy-mm-dd" });
    });
    var viewBox = function( num ) {
        $$('#boxheader' + num).toggleClass('wff-minimized');
        $$('#boxdata' + num).toggle('fast');
        $$('.footable').resize();
    };
    var viewAllBoxes = function( num, Nb ) {
        k = parseInt(num) + 1;
        N = k + parseInt(Nb);
        while (k < N) { viewBox(k); k = k + 1; };
    };
</script>

<div class='wff-infobox'>
    <p class='wff-infobox-heading'>Boxes</p>
    <p class='wff-infobox-content'>If you want to modify some entries in your Boxes, please do that via the <a href="https://drive.google.com">Google Drive</a> web interface. Refresh this page after.</p>
</div>

<div class='wff-infobox'>
    <p class='wff-infobox-heading'>Search</p>
    <p class='wff-infobox-content'>filter all items for <input id="filter" type="text"/>.</p>
</div>

<div class"wff-all-boxes-expand">
$ num = -1
$for ssid, ssname in zip(SSID,SPREADSHEETS):
    $ boxes = sscoll[ssid]
    $ Nb = len(boxes)
    <p class='wff-boxes-spreadsheet-heading' onclick="viewAllBoxes( $(num), $(Nb) )"><a>$(ssname)</a></p>
    $for box in boxes:
        $ num += 1
        $ name = box['name']
        $ boxid = box['ssid']
        $ labels = box['labels']
        $ Nlabels = max(labels.keys())
        $ flies = box['flies']
        $ modified = box.get('modified', 'flipped: N/A')
        $ scheduled = box.get('scheduled', 'N/A')
        
        <!-- Calendar config -->
        <div class='wff-boxes-calendar-container wff-minimized' id='boxheader$(num)'>
            <p>
            <span><strong><a onclick="viewBox($(num))">$name</a></strong></span>
            <span>scheduled: $(scheduled)</span>
            <span><a href='/boxes?flipped=True&ssid=$(boxid)&boxname=$(name)'>$(modified)</a></span>
            $if box['mode'] in ['BOXADD']:
                <span><a href="javascript:void(0)" onclick="$$('#boxaddcalendar$(num)').toggle('fast')">add_to_calendar</a></span>
            </p>
            
            $if box['mode'] in ['BOXOVERRIDE']:
                <p><span>
                WARNING: box has an id! Did you select the calendar?
                <a href="javascript:void(0)" onclick="$$('#boxaddcalendar$(num)').toggle('fast')">override and add_to_calendar</a>
                </span></p>

        <!-- BOXADD to Calendar menu -->
        $if box['mode'] in ['BOXADD', 'BOXOVERRIDE']:
            <div id='boxaddcalendar$(num)' style='display:none'>
            <form action="/boxes">
            <input style='display:none' name="add" value="True" />
            <input style='display:none' name="ssid" value="$(boxid)" />
            <input style='display:none' name="boxname" value="$(name)" />
            <table>
                <tr>
                    <td>start:</td>
                    <td><input type='text' class="datepicker" name="start" size="12" /></td>
                </tr>
                <tr>
                    <td>every:</td>
                    <td><input name="freq" value="28" size='3'/>days.</td>
                </tr>
                <tr>
                    <td>location:</td>
                    <td><input type='text' name="location" size="20"/></td>
                </tr>
                <tr>
                    <td>calendar:</td>
                    <td><select name='clid'>
                    $for cc, cn in zip(CLID,CALENDARS):
                        <option value="$(cc)">$(cn)</option>
                    </select></td>
                </tr>
                <tr>
                    <td></td>
                    <td><input type="submit" value="add to calendar"></td>
                </tr>
            </table>
            </form>
            </div>
        </div>

        <!-- THE BOX -->

        <div class='wff-footable-container footable-noleftcorner' id='boxdata$(num)' style='display:none'>
        $ OVERDUE = False    
        $ ddd = scheduled.split()
        $ if len(ddd) == 3 and int(ddd[1]) > 0: OVERDUE = False
        $ else: OVERDUE = True
        $if box['mode'] == 'BOXSHOW' and OVERDUE:
            <table data-filter="#filter" class='footable footable-noleftcorner'>
        $else:
            <table data-filter="#filter" class='footable wff-box-flipped footable-noleftcorner'>
        <thead class='footable-noleftcorner'>
        <tr>
        $for i in range(1,Nlabels+1):
            $ label = box['labels'].get(i, '')
            $if label == 'Label':
                <th data-class='expand'>$(label)</th>
            $elif label == 'Short Identifier':
                <th>$(label)</th>
            $elif label in ['X', 'Y', 'C2a', 'C2b', 'C3a','C3b']:
                <th data-hide='phone,tablet'>$(label)</th>
            $else:
                <th data-hide='phone'>$(label)</th>
        </tr>
        </thead>
        <tbody>
        $for fly in flies:
            <tr>
            $for i in range(1,Nlabels+1):
                <td>$fly.get(labels.get(i,''),'')</td>
            </tr>
        </tbody>
        </table>
        </div>
<div>
